{% from "haproxy/map.jinja" import haproxy, haproxy_role with context %}

global
    log         127.0.0.1 local0 {{ haproxy.loglevel }}

    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4096
    user        haproxy
    group       haproxy
    daemon

    # turn on stats unix socket
    stats socket /var/lib/haproxy/stats

    # safety first
    tune.ssl.default-dh-param 2048


defaults
    log                     global
    mode                    http

    # let's extend default httplog format to capture ssl and request-id details
#    option httplog
    log-format %ci:%cp\ [%t]\ %ft\ %b/%s\ %Tq/%Tw/%Tc/%Tr/%Tt\ %ST\ %B\ %CC\ \ %CS\ %tsc\ %ac/%fc/%bc/%sc/%rc\ %sq/%bq\ %hr\ %hs\ %{+Q}r\ {request_id=%ID,%[capture.req.hdr(0)]\ ssl_version=%sslv\ ssl_cypher=%sslc}

    option                  http-server-close
    option                  redispatch
    option                  forwardfor

    retries                 3

    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s

    maxconn                 3000

    unique-id-format %{+X}o\ %ci:%cp_%fi:%fp_%Ts_%rt:%pid
    unique-id-header X-Request-ID


{% if haproxy.this.ssl %}

    frontend http
        bind *:{{haproxy.this.http_port}}
        reqadd X-Forwarded-Proto:\ http
        capture request header X-Request-ID len 64
        capture request header User-Agent len 200

        redirect scheme https


    frontend https
        bind *:{{haproxy.this.https_port}} ssl crt /etc/ssl/certs/ssl.pem ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:AES128:AES256:RC4-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK
        reqadd X-Forwarded-Proto:\ https
        capture request header X-Request-ID len 64
        capture request header User-Agent len 200

        redirect scheme https if !{ ssl_fc }
        default_backend             webapp

{% else %}

    frontend http
        bind *:80
        reqadd X-Forwarded-Proto:\ http
        capture request header X-Request-ID len 64
        capture request header User-Agent len 200

        default_backend             webapp

{% endif %}


backend webapp
    balance      roundrobin

    # for sticky sessions:
    # cookie  LBSTICKY insert indirect nocache httponly secure maxlife 8h
    # server  app1 10.10.10.10:8080 cookie app1

    {% for host, ips in salt['mine.get']('roles:apps.pvb', 'network.ip_addrs', 'grain').iteritems() %}
    server       webapp{{loop.index}} {{ips[0]}}:{{haproxy.this.downstream_port}} check
    {% endfor %}
